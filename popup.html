<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="popup.css" type="text/css" media="screen" />
</head>
<body>
  <input id="image_input" type="file" name="media" accept="image/*"/>
  <label for="x">X:</label>
  <input type="text" id="x" value="0" />

  <label for="y">Y:</label>
  <input type="text" id="y" value="0" />

  <label for="z">Z:</label>
  <input type="text" id="z" value="10" />

  <label for="enabled">Enabled:</label>
  <input type="checkbox" id="enabled" />
    
  <script>
    var backgroundPage = chrome.extension.getBackgroundPage();

    var searchTerm = document.location.search;
    var tabId = searchTerm.substring(1, searchTerm.length);
    var elements = Array.prototype.slice.call(document.querySelectorAll('input'));
    var textElements = Array.prototype.slice.call(document.querySelectorAll('input[type="text"]'));

    var initializeData = function() {
      var currentData = backgroundPage.getData(tabId);
      if(!currentData) {
        return;
      }
      elements.forEach(function(element) {
        if(element.type == 'text') {
          element.value = currentData[element.id];
        } else if(element.type == 'checkbox') {
          element.checked = currentData[element.id];
        }
      });
    };

    var updateElements = function(imgData) {
      var formData = {};
      elements.forEach(function(element) {
        if(element.type == 'text') {
          formData[element.id] = element.value;
        } else if(element.type == 'checkbox') {
          formData[element.id] = element.checked;
        }
      });
      if(imgData) {
        formData['imgData'] = imgData;
      }
      formData['tabId'] = tabId;
      backgroundPage.updateImg(formData);
    };

    var onFormChange = function(e) {
      if(e.type == 'change') {
        var file = e.target.files[0];
        if(!file) {
          return;
        }
        var reader = new FileReader();
        reader.onload = function() {
          enabled.checked = 'checked';
          updateElements(reader.result);
        };
        reader.readAsBinaryString(file);
      } else {
        if(e.keyCode && e.keyCode == 38 || e.keyCode == 40) {
          return;
        }
        updateElements();
      }
    };

    initializeData();
    elements.forEach(function(element) {
      var eventType;
      if(element.type == 'text') {
        eventType = 'keyup';
      } else if(element.type == 'file') {
        eventType = 'change';
      } else if(element.type == 'checkbox') {
        eventType = 'click';
      }
      element.addEventListener(eventType, onFormChange, false);
    });


    var pastTimeout = null;
    textElements.forEach(function(element) {
      element.addEventListener('keydown', function(e) {
        var intValue = parseInt(element.value, 10);
        if(isNaN(intValue)) {
          intValue = 0;
        }
        if(e.keyCode == 38) {
          intValue += 1;
        } else if(e.keyCode == 40) {
          intValue -= 1;
        }
        if(element.value != intValue) {
          element.value = intValue;
          if(pastTimeout) {
            clearTimeout(pastTimeout);
          }
          pastTimeout = setTimeout(function() {
            updateElements();
          }, 100);
        }
      }, false);
    });
  </script>
</body>
</html>