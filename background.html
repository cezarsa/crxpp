<!DOCTYPE html>
<html>
<body>
<script>

var storage = {
    _storage: {},
    save: function(data) {
        var oldData = this.get(data.tabId);
        if (oldData && !data.imgData) {
            data.imgData = oldData.imgData;
        }
        this._storage[data.tabId] = data;
    },
    get: function(id) {
        return this._storage[id];
    }
};

var sendData = function(tabId, opts) {
    var tabData = storage.get(tabId) || {tabId: tabId};

    if (opts && opts.toggle) {
        tabData.visible = !tabData.visible;
    } else if (!tabData.visible) {
        return;
    }

    storage.save(tabData);
    chrome.tabs.sendRequest(tabId, {
        action: 'toggle',
        pageData: tabData
    });
};

chrome.browserAction.onClicked.addListener(function(tab) {
    sendData(tab.id, {toggle: true});
});

chrome.extension.onRequest.addListener(function(request) {
    switch (request.action) {

    case 'save':
        storage.save(request.pageData);
        break;

    case 'request':
        chrome.tabs.getSelected(function(tab) {
            sendData(tab.id);
        });

    }
});

</script>
</body>
</html>



