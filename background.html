<!DOCTYPE html>
<html>
<body>
<script>
var lastTab = null;
chrome.browserAction.onClicked.addListener(function(tab) {
  lastTab = tab;
  window.open(chrome.extension.getURL('popup.html'), 'crxpp_popup', 'width=300,height=200,location=no,menubar=no,resizable=yes,status=no,titlebar=yes,toolbar=no');
});

var allData = {};
function updateImg(x, y, z, imgData) {
  var pageData = allData[lastTab.url];
  if(!pageData) {
    pageData = allData[lastTab.url] = {};
  }
  if(imgData) {
    pageData.imgData = imgData;
  }
  pageData.x = parseInt(x, 10) || 0;
  pageData.y = parseInt(y, 10) || 0;
  pageData.z = parseInt(z, 10) || 0;

  chrome.tabs.sendRequest(lastTab.id, {
    action: 'update',
    url: lastTab.url,
    pageData: pageData
  });
}

function clear() {
  delete allData[lastTab.url];
  chrome.tabs.sendRequest(lastTab.id, {
    action: 'clear',
    url: lastTab.url
  });
}

function getData() {
  return allData[lastTab.url];
}

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  if(request.action != 'request') {
    return;
  }
  if(allData[request.url]) {
    chrome.tabs.getAllInWindow(null, function(tabs) {
      for(var i = 0, len = tabs.length; i < len; ++i) {
        if(tabs[i].url == request.url) {
          chrome.tabs.sendRequest(tabs[i].id, {
            action: 'update',
            url: request.url,
            pageData: allData[request.url]
          });
          break;
        }
      }
    });
  }
});
</script>
</body>
</html>



